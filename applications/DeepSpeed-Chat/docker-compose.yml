services:
  deepspeed-training:
    build:
      context: .
      dockerfile: Dockerfile
    image: deepspeed-training:latest
    container_name: deepspeed-training
    
    privileged: true
    runtime: nvidia
    
    command: /bin/bash -c "/usr/sbin/sshd && tail -f /dev/null"
    
    environment:
      - PROJECT_PATH=${PROJECT_PATH:-/workspace}
      - HF_HOME=${PROJECT_PATH:-/workspace}/.cache/huggingface
      - TRANSFORMERS_CACHE=${PROJECT_PATH:-/workspace}/.cache/huggingface/transformers
      - HF_DATASETS_CACHE=${PROJECT_PATH:-/workspace}/.cache/huggingface/datasets
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    
    volumes:
      # Mount DeepSpeedExamples repo to /workspace/DeepSpeedExamples
      - ${HOST_REPO_PATH}:${PROJECT_PATH}/DeepSpeedExamples:rw
      
      # Mount cache to /workspace/.cache
      - ${HOST_CACHE_PATH}:${PROJECT_PATH}/.cache:rw
    
    stdin_open: true
    tty: true
    ipc: host
    shm_size: '32gb'
    
    working_dir: /workspace/DeepSpeedExamples/applications/DeepSpeed-Chat/training
